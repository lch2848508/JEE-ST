<?xml version="1.0" encoding="utf-8"?>
<s:VGroup creationComplete="vgroup1_creationCompleteHandler(event)" gap="0" xmlns:fx="http://ns.adobe.com/mxml/2009" xmlns:s="library://ns.adobe.com/flex/spark"
		  xmlns:mx="library://ns.adobe.com/flex/mx" width="100%" height="100%">
	<fx:Script>
		<![CDATA[
			import com.webgis.MapLayerManager;
			import com.webgis.event.MapModeEvent;
			import com.webgis.map.MapControl;
			import com.webgis.service.MapServiceClient;

			import mx.collections.ArrayCollection;
			import mx.core.FlexGlobals;
			import mx.core.UIComponent;
			import mx.events.DragEvent;
			import mx.events.FlexEvent;
			import mx.managers.DragManager;
			public var map:MapControl=null;
			public var mapServiceClient:MapServiceClient=null;
			[Bindable]
			public var dataProvider:ArrayCollection=null;
			[Bindable]
			public var mapLayerManager:MapLayerManager=null;


			protected function vgroup1_creationCompleteHandler(event:FlexEvent):void
			{
				FlexGlobals.topLevelApplication.addEventListener(MapModeEvent.SWITCHLAYER, function(event:MapModeEvent):void
				{
					if (dataProvider)
					{
						dataProvider.refresh();
						layerList.invalidateList();
					}
				});
			}

			public function moveUp():void
			{
				var index:int=layerList.selectedIndex;
				if (index == 0 || index < 0)
					return;
				var item:Object=dataProvider.getItemAt(index);
				dataProvider.removeItemAt(dataProvider.getItemIndex(item));
				dataProvider.addItemAt(item, index - 1);
				dataProvider.refresh();
				layerList.invalidateList();
				layerList.callLater(function():void
				{
					layerList.selectedIndex=index - 1;
					layerList.callLater(function():void
					{
						layerList.scrollToIndex(layerList.selectedIndex);
					});
				});
				mapLayerManager.sortDynamicLayers(map, "selected");
				saveToServer();
			}

			public function moveDown():void
			{
				var index:int=layerList.selectedIndex;
				if (index == dataProvider.length - 1 || index < 0)
					return;
				var item:Object=dataProvider.getItemAt(index);
				dataProvider.removeItemAt(dataProvider.getItemIndex(item));
				dataProvider.addItemAt(item, index + 1);
				dataProvider.refresh();
				layerList.invalidateList();
				layerList.callLater(function():void
				{
					layerList.selectedIndex=index + 1;
					layerList.callLater(function():void
					{
						layerList.scrollToIndex(layerList.selectedIndex);
					});
				});
				mapLayerManager.sortDynamicLayers(map, "selected");
				saveToServer();
			}

			protected function layerList_keyDownHandler(event:KeyboardEvent):void
			{
				if (event.ctrlKey)
				{
					if (event.keyCode == Keyboard.UP)
						moveUp();
					else if (event.keyCode == Keyboard.DOWN)
						moveDown();
				}
			}

			public function saveToServer():void
			{
				var params:Object={serverIds: [], serverId2Alpha: {}};
				var source:Array=dataProvider.source;
				for (var i:int=0; i < source.length; i++)
				{ 
					var item:Object=source[i];
					params.serverIds.push(item.id);
					params.serverId2Alpha[item.id]=item.layerAlpha;
				}
				mapServiceClient.executeMethod("saveLayerOverlay", {content: JSON.stringify(params)}, function(json:Object):void
				{

				});
			}
		]]>
	</fx:Script>
	<s:Line id="line" width="100%" height="0">
		<s:stroke>
			<s:SolidColorStroke color="#7B889C"/>
		</s:stroke>
	</s:Line>
	<mx:List keyDown="layerList_keyDownHandler(event)" borderStyle="none" borderVisible="false" itemRenderer="com.webgis.module.layertree.LayerTreeViewItemRender"
			 width="100%" dataProvider="{dataProvider}" height="100%" id="layerList" labelField="name">

	</mx:List>
</s:VGroup>
